-- LinoriaUmbrella.lua
-- Hybrid: Linoria-style API with Umbrella-style visuals
-- Drop this file into your scripts and require it or dofile it.

local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local TextService = game:GetService("TextService")
local CoreGui = game:GetService("CoreGui")

local LocalPlayer = Players.LocalPlayer

-- Basic protectgui (works with some exploit envs)
local protectgui = protectgui or (syn and syn.protect_gui) or (function(g) pcall(function() g.Parent = CoreGui end) end)

-- Globals
getgenv().Toggles = getgenv().Toggles or {}
local Toggles = getgenv().Toggles
local Options = {}
getgenv().Options = Options

-- Colors/style (Umbrella inspired)
local STYLE = {
    ACCENT = Color3.fromRGB(255,75,75),
    TEXT = Color3.fromRGB(200,200,200),
    BG = Color3.fromRGB(20,20,22),
    DARK = Color3.fromRGB(15,15,17),
    ELEM = Color3.fromRGB(30,30,32),
    OUTLINE = Color3.fromRGB(40,40,42),
    FONT = Enum.Font.Gotham
}

-- Utility helpers
local function tween(instance, props, t)
    t = t or 0.18
    local info = TweenInfo.new(t, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
    local tw = TweenService:Create(instance, info, props)
    tw:Play()
    return tw
end

local function create(class, props)
    local inst = Instance.new(class)
    if props then
        for k,v in pairs(props) do
            if pcall(function() inst[k] = v end) then end
        end
    end
    return inst
end

local ScreenGui = create("ScreenGui", {Name = "LinoriaUmbrellaUI", ZIndexBehavior = Enum.ZIndexBehavior.Sibling})
protectgui(ScreenGui)
ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

-- Main window factory
local Library = {}
Library.Windows = {}

function Library:CreateWindow(config)
    config = config or {}
    local Title = config.Title or "LinoriaUmbrella"
    local Pos = config.Position or UDim2.fromScale(0.5,0.5)
    local Size = config.Size or UDim2.new(0,700,0,420)

    local Main = create("Frame", {
        Name = "LU_Window",
        AnchorPoint = Vector2.new(0.5,0.5),
        Position = Pos,
        Size = Size,
        BackgroundColor3 = STYLE.BG,
        BorderSizePixel = 0,
        ZIndex = 1000,
        Parent = ScreenGui
    })

    local Corner = create("UICorner", {Parent = Main, CornerRadius = UDim.new(0,8)})
    local Header = create("Frame", {
        BackgroundColor3 = STYLE.DARK,
        Size = UDim2.new(1,0,0,36),
        Parent = Main
    })
    create("UICorner", {Parent=Header, CornerRadius = UDim.new(0,6)})

    local TitleLabel = create("TextLabel", {
        Text = Title,
        TextSize = 20,
        Font = STYLE.FONT,
        TextColor3 = STYLE.TEXT,
        BackgroundTransparency = 1,
        Position = UDim2.new(0,12,0,0),
        Size = UDim2.new(1,-24,1,0),
        Parent = Header
    })

    -- Left: categories; Right: module/settings area
    local Left = create("Frame", {
        BackgroundColor3 = STYLE.DARK,
        Position = UDim2.new(0,8,0,46),
        Size = UDim2.new(0,200,1,-54),
        Parent = Main
    })
    create("UICorner", {Parent=Left, CornerRadius = UDim.new(0,6)})

    local Right = create("Frame", {
        BackgroundColor3 = STYLE.ELEM,
        Position = UDim2.new(0,216,0,46),
        Size = UDim2.new(1,-232,1,-54),
        Parent = Main
    })
    create("UICorner", {Parent=Right, CornerRadius = UDim.new(0,6)})

    -- Layout containers
    local CatList = create("ScrollingFrame", {
        BackgroundTransparency = 1,
        Size = UDim2.new(1,0,1,0),
        Parent = Left,
        ScrollBarThickness = 4
    })
    local CatLayout = create("UIListLayout", {Parent = CatList, Padding = UDim.new(0,6), SortOrder = Enum.SortOrder.LayoutOrder})

    local ModuleArea = create("Frame", {BackgroundTransparency = 1, Size = UDim2.new(1,0,1,0), Parent = Right})
    local ModuleScroll = create("ScrollingFrame", {Parent = ModuleArea, BackgroundTransparency = 1, Size = UDim2.new(1,0,1,0), ScrollBarThickness = 4})
    local ModuleLayout = create("UIListLayout", {Parent = ModuleScroll, Padding = UDim.new(0,6)})

    -- window object to return
    local Window = {
        Main = Main,
        Left = Left,
        Right = Right,
        CatList = CatList,
        ModuleArea = ModuleArea,
        Tabs = {},
    }

    -- drag
    do
        local dragging = false
        local offset = Vector2.new(0,0)
        Header.InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                dragging = true
                offset = Vector2.new(input.Position.X - Main.AbsolutePosition.X, input.Position.Y - Main.AbsolutePosition.Y)
                input.Changed:Connect(function()
                    if input.UserInputState == Enum.UserInputState.End then dragging = false end
                end)
            end
        end)
        Header.InputChanged:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseMovement and dragging then
                Main.Position = UDim2.fromOffset(input.Position.X - offset.X, input.Position.Y - offset.Y)
            end
        end)
    end

    -- API: AddTab (category on left)
    function Window:AddTab(name)
        local btn = create("TextButton", {
            Text = name,
            Size = UDim2.new(1,-12,0,34),
            Position = UDim2.new(0,6,0,0),
            BackgroundColor3 = STYLE.DARK,
            BorderSizePixel = 0,
            AutoButtonColor = false,
            Parent = CatList
        })
        create("UICorner", {Parent=btn, CornerRadius = UDim.new(0,6)})
        local txt = btn

        btn.MouseEnter:Connect(function() tween(btn, {BackgroundColor3 = STYLE.ELEM}, 0.12) end)
        btn.MouseLeave:Connect(function() tween(btn, {BackgroundColor3 = STYLE.DARK}, 0.12) end)

        -- content container for this tab
        local content = create("Frame", {BackgroundTransparency = 1, Size = UDim2.new(1,0,0,0), Parent = ModuleScroll})
        local contLayout = create("UIListLayout", {Parent = content, Padding = UDim.new(0,8)})

        function Window:ShowTab()
            for _, c in pairs(ModuleScroll:GetChildren()) do
                if c ~= content and c:IsA("Frame") then c.Visible = false end
            end
            content.Visible = true
            -- adjust canvas
            ModuleScroll.CanvasSize = UDim2.new(0,0,0,contLayout.AbsoluteContentSize.Y)
        end

        btn.MouseButton1Click:Connect(function()
            Window:ShowTab()
        end)

        local TabObj = {
            Name = name,
            Container = content,
            AddToggle = function(_, id, info) return Window._AddToggle(content, id, info) end,
            AddSlider = function(_, id, info) return Window._AddSlider(content, id, info) end,
            AddDropdown = function(_, id, info) return Window._AddDropdown(content, id, info) end,
            AddLabel = function(_, txt) return Window._AddLabel(content, txt) end,
            AddButton = function(_, id, info) return Window._AddButton(content, id, info) end,
            AddColorPicker = function(_, id, info) return Window._AddColorPicker(content, id, info) end,
            -- more Linoria-compatible functions can be added here...
        }

        Window.Tabs[name] = TabObj
        return TabObj
    end

    -- Internal element creators (Linoria-compatible signatures)
    function Window._AddLabel(self, parent, text)
        local lbl = create("TextLabel", {
            Text = text,
            Size = UDim2.new(1,-8,0,20),
            BackgroundTransparency = 1,
            TextColor3 = STYLE.TEXT,
            Font = STYLE.FONT,
            TextSize = 15,
            TextXAlignment = Enum.TextXAlignment.Left,
            Parent = parent
        })
        return lbl
    end

    function Window._AddToggle(self, parent, id, info)
        info = info or {}
        assert(info.Text, "AddToggle: Missing Text")
        local outer = create("Frame", {Size = UDim2.new(1,-8,0,28), BackgroundColor3 = STYLE.ELEM, Parent = parent})
        create("UICorner", {Parent = outer, CornerRadius = UDim.new(0,6)})
        local label = create("TextLabel", {Text = info.Text, BackgroundTransparency = 1, TextColor3 = STYLE.TEXT, Font = STYLE.FONT, TextSize = 14, Position = UDim2.new(0,8,0,0), Size = UDim2.new(1,-60,1,0), Parent = outer})

        local btn = create("TextButton", {Size = UDim2.new(0,44,0,20), Position = UDim2.new(1,-52,0,4), BackgroundColor3 = STYLE.DARK, AutoButtonColor = false, Parent = outer})
        create("UICorner", {Parent = btn, CornerRadius = UDim.new(0,6)})

        local state = info.Default or false
        local function reflect()
            if state then
                tween(btn, {BackgroundColor3 = STYLE.ACCENT}, 0.14)
                btn.Text = "ON"
                btn.TextColor3 = Color3.new(1,1,1)
            else
                tween(btn, {BackgroundColor3 = STYLE.DARK}, 0.14)
                btn.Text = "OFF"
                btn.TextColor3 = STYLE.TEXT
            end
        end
        reflect()

        btn.MouseButton1Click:Connect(function()
            state = not state
            reflect()
            if info.Callback then
                pcall(info.Callback, state)
            end
            -- store in Toggles/Options for Linoria-compat
            Toggles[id] = Toggles[id] or {}
            Toggles[id].Value = state
            if Options[id] then Options[id].Value = state end
        end)

        -- expose simple object compatible with Linoria
        local ToggleObj = { Value = state, Type = "Toggle" }
        function ToggleObj:SetValue(v) state = not not v; reflect(); if info.Callback then pcall(info.Callback, state) end end
        function ToggleObj:OnChanged(f) ToggleObj.Changed = f; f(state) end

        Options[id] = ToggleObj
        Toggles[id] = ToggleObj

        return ToggleObj
    end

    function Window._AddSlider(self, parent, id, info)
        assert(info.Text and info.Min and info.Max and info.Rounding, "AddSlider: missing params")
        local outer = create("Frame", {Size = UDim2.new(1,-8,0,44), BackgroundColor3 = STYLE.ELEM, Parent = parent})
        create("UICorner",{Parent = outer, CornerRadius = UDim.new(0,6)})
        local label = create("TextLabel", {Text = info.Text, BackgroundTransparency = 1, TextColor3 = STYLE.TEXT, Font = STYLE.FONT, TextSize = 14, Position = UDim2.new(0,8,0,4), Size = UDim2.new(1,-16,0,18), Parent = outer})
        local barBg = create("Frame", {BackgroundColor3 = STYLE.DARK, Position = UDim2.new(0,8,0,26), Size = UDim2.new(1,-16,0,10), Parent = outer})
        create("UICorner",{Parent = barBg, CornerRadius = UDim.new(0,4)})
        local fill = create("Frame", {BackgroundColor3 = STYLE.ACCENT, Size = UDim2.new( (info.Default - info.Min)/(info.Max - info.Min), 0, 1, 0), Parent = barBg})
        create("UICorner",{Parent = fill, CornerRadius = UDim.new(0,4)})

        local dragging=false
        barBg.InputBegan:Connect(function(input)
            if input.UserInputType==Enum.UserInputType.MouseButton1 then
                dragging=true
            end
        end)
        UserInputService.InputEnded:Connect(function(input) if input.UserInputType==Enum.UserInputType.MouseButton1 then dragging=false end end)
        UserInputService.InputChanged:Connect(function(input)
            if dragging and input.UserInputType==Enum.UserInputType.MouseMovement then
                local rel = math.clamp((input.Position.X - barBg.AbsolutePosition.X) / barBg.AbsoluteSize.X, 0, 1)
                fill.Size = UDim2.new(rel,0,1,0)
                local value = info.Min + (info.Max - info.Min) * rel
                value = math.floor(value / info.Rounding + 0.5) * info.Rounding
                if info.Callback then pcall(info.Callback, value) end
                Options[id] = Options[id] or {}
                Options[id].Value = value
            end
        end)

        local SliderObj = { Value = info.Default or info.Min, Type = "Slider" }
        function SliderObj:SetValue(v)
            local rel = math.clamp((v - info.Min)/(info.Max - info.Min), 0,1)
            fill.Size = UDim2.new(rel,0,1,0)
            SliderObj.Value = v
            if info.Callback then pcall(info.Callback, v) end
        end
        Options[id] = SliderObj
        return SliderObj
    end

    function Window._AddDropdown(self, parent, id, info)
        assert(info.Values, "AddDropdown: Missing Values")
        local outer = create("Frame", {Size = UDim2.new(1,-8,0,34), BackgroundColor3 = STYLE.ELEM, Parent = parent})
        create("UICorner", {Parent = outer, CornerRadius = UDim.new(0,6)})
        local label = create("TextLabel", {Text = info.Text or "Dropdown", BackgroundTransparency = 1, TextColor3 = STYLE.TEXT, Font = STYLE.FONT, TextSize = 14, Position = UDim2.new(0,8,0,0), Size = UDim2.new(1,-120,1,0), Parent = outer})

        local button = create("TextButton", {Size = UDim2.new(0,110,0,24), Position = UDim2.new(1,-118,0,5), BackgroundColor3 = STYLE.DARK, AutoButtonColor=false, Parent = outer})
        create("UICorner",{Parent=button, CornerRadius = UDim.new(0,6)})
        local sel = create("TextLabel", {Text = info.Default or "--", BackgroundTransparency = 1, TextColor3 = STYLE.TEXT, Font = STYLE.FONT, TextSize = 14, Size = UDim2.new(1,-8,1,0), Position = UDim2.new(0,6,0,0), Parent = button})

        local menu = create("Frame", {Size = UDim2.new(0,130,0,0), BackgroundColor3 = STYLE.DARK, Visible = false, Parent = ScreenGui})
        create("UICorner",{Parent=menu, CornerRadius = UDim.new(0,6)})
        local menuList = create("UIListLayout", {Parent = menu, Padding = UDim.new(0,4)})

        local function rebuild()
            for _,c in pairs(menu:GetChildren()) do
                if c:IsA("TextButton") then c:Destroy() end
            end
            local y=6
            for i,v in ipairs(info.Values) do
                local opt = create("TextButton", {Text = v, Size = UDim2.new(1,-12,0,26), Position = UDim2.new(0,6,0,y), BackgroundColor3 = STYLE.DARK, Parent = menu})
                create("UICorner",{Parent=opt, CornerRadius = UDim.new(0,6)})
                opt.MouseEnter:Connect(function() tween(opt, {BackgroundColor3 = STYLE.ELEM}, 0.12) end)
                opt.MouseLeave:Connect(function() tween(opt, {BackgroundColor3 = STYLE.DARK}, 0.12) end)
                opt.MouseButton1Click:Connect(function()
                    sel.Text = v
                    menu.Visible = false
                    if info.Callback then pcall(info.Callback, v) end
                    Options[id] = Options[id] or {}
                    Options[id].Value = v
                end)
                y = y + 32
            end
            menu.Size = UDim2.new(0,140,0, y)
        end
        rebuild()

        button.MouseButton1Click:Connect(function()
            menu.Position = UDim2.fromOffset(button.AbsolutePosition.X, button.AbsolutePosition.Y + button.AbsoluteSize.Y + 6)
            menu.Visible = not menu.Visible
        end)

        local DDObj = { Value = info.Default or nil, Type = "Dropdown" }
        function DDObj:SetValue(v)
            if table.find(info.Values, v) then
                sel.Text = v
                DDObj.Value = v
                if info.Callback then pcall(info.Callback, v) end
            end
        end
        Options[id] = DDObj
        return DDObj
    end

    function Window._AddButton(self, parent, id, info)
        local bframe = create("TextButton", {Text = info.Text or "Button", Size = UDim2.new(1,-8,0,30), BackgroundColor3 = STYLE.ACCENT, Parent = parent})
        create("UICorner",{Parent=bframe, CornerRadius = UDim.new(0,6)})
        bframe.MouseEnter:Connect(function() tween(bframe, {BackgroundColor3 = STYLE.ELEM}, 0.12) end)
        bframe.MouseLeave:Connect(function() tween(bframe, {BackgroundColor3 = STYLE.ACCENT}, 0.12) end)
        bframe.MouseButton1Click:Connect(function()
            if info.Callback then pcall(info.Callback) end
        end)
        return bframe
    end

    -- finalize window object
    Library.Windows[#Library.Windows+1] = Window
    return Window
end

-- Public API
return {
    CreateWindow = function(...) return Library:CreateWindow(...) end,
    _internal = Library,
    Toggles = Toggles,
    Options = Options
}
